# Redis设计与实现(七): 多机数据库的实现

### 复制
1. Redis的复制功能分为同步(sync)和命令传播(command propagate)两个操作：
    * 同步操作用于将从服务器的数据库状态更新至主服务器当前所处的服务器状态
    * 命令传播则用于在主服务器的数据库状态被修改，导致主从服务器的数据库状态出现不一致时，让主从服务器的数据库重新回到一致状态
2. 从服务器对主服务器的同步操作需要通过向主服务器发送SYNC命令来完成，以下是SYNC命令的执行步骤：
    * 从服务器向主服务器发送SYNC命令
    * 收到SYNC命令的主服务器执行BGSAVE命令，在后台生成一个RDB文件，并使用一个缓冲区记录从现在开始执行的所有命令
    * 当主服务器的BGSAVE命令执行完毕时，主服务器将BGSAVE命令生成的RDB文件发送给从服务器，从服务器接收并载入这个RDB文件，将自己的数据库状态更新至主服务器执行BGSAVE命令时的数据库状态
    * 主服务器将记录在缓冲区里面的所有写命令发送给从服务器，从服务器执行这些写命令，将自身的数据库状态更新至主服务器数据库当前所处的状态
3. 命令传播操作即主服务器会将自己执行的写命令，也即是造成主从服务器不一致的那条写命令，发送给从服务器执行，当从服务器执行了相同的写命令之后，主从服务器再次回到一致状态
4. 为了解决旧版复制功能在处理断线重复制时的低效情况，Redis从2.8版本开始，使用PSYNC命令代替SYNC命令来执行复制时的同步操作。PSYNC命令具有完整重同步和部分重同步两种模式：
    * 其中完整重同步用于初次复制情况：其执行步骤和SYNC命令的执行步骤基本一致，它们都是通过让主服务器创建并发送RDB文件，以及向从服务器发送保存在缓冲区里面的写命令来进行同步
    * 部分重同步则用于处理断线后重复制情况：当从服务器在断线后重新连接主服务器时，如果条件允许，主服务器可以将主从服务器连接断开期间执行的写命令发送给从服务器，从服务器只需执行这些写命令，就可以将数据库更新至主服务器当前所处的状态。
5. 部分重同步功能由以下三个部分构成：
    * 主服务器的复制偏移量(replication offset)和从服务器的复制偏移量
    * 主服务器的复制积压缓冲区(replication backlog)
    * 服务器的运行ID(run ID)

6. 复制偏移量：执行复制的双方，主从服务器都分别维护一个复制偏移量：
    * 主服务器每次向从服务器传播N个字节的数据时，就将自己的复制偏移量的值加上N。
    * 从服务器每次收到主服务器传来的N个字节数据时，就将自己的复制偏移量的值加上N。
    * 通过对比主从服务器的复制偏移量是否一致，程序就可以判断出主从服务器是否处于一致状态。
7. 复制积压缓冲区是由主服务器维护的一个固定长度(fixed-size)先进先出队列，默认大小为1MB。当主服务器进行命令传播时，它不仅会将写命令发送给所有从服务器，还会将写命令入队到复制积压缓冲区里面。

### Sentinel
1. Sentinel(哨岗、哨兵)是Redis的高可用性(high availability)解决方案：由一个或多个Sentinel实例(instance)组成的Sentinel系统(system)可以监视任意多个主服务器，以及这些主服务器属下的所有从服务器，并在被监视的主服务器进入下线状态时，自动将下线主服务器属下的某个从服务器升级为新的主服务器，然后由新的主服务器代替已下线的主服务器继续处理命令请求。
2. 当一个Sentinel启动时，它需要执行以下步骤：
    * 初始化服务器
    * 将普通Redis服务器所使用的代码替换为Sentinel专用代码
    * 初始化Sentinel状态
    * 根据给定的配置文件，初始化Sentinel的监视主服务器列表
    * 创建连向主服务器的网络连接

3. 初始化服务器：因为Sentinel本质上是一个运行在特殊模式下的Redis服务器，所以启动Sentinel的第一步，就是初始化一个普通的Redis服务器。




























                        



